{"changed":true,"filter":false,"title":"swarm_redistribution.js","tooltip":"/swarm_redistribution.js","value":"exports.API = function(db, account_id, callback){\n    \n\n\n\n// ---------------------------- swarm-redistribution API ----------------------------------\n\n// coin-agnostic general purpuse API - connect any coin platform\n// my swarm-redistribution API is the major component of project resilience\n// and what I called peer-to-peer-dividend-protocols\n// http://resilience.me and http://basicincome.co\n\n// the API can be used by any coin, money, thing, platform\n\n// first, get_collection() loads a nodes dividend pathways\n// see video Systems-Architechture [2014], https://www.youtube.com/watch?v=PmPq3ywnnoI\n\n\n\n\n// ---------------------------- swarm-redistribution ----------------------------------\n\n// FIRST, collect data from the coin platform\n\n // this example connects with http://client.basicincome.co\n\n\nvar COLLECTION = db.collection(account_id);\nconsole.log(COLLECTION)\n    var taxRate\n    var total_amount\n\n    \n    var currency\n    var q = 0\n\nvar get_dividend_lines = function(callback){\n    get_wallet()\n    function get_wallet(){\n    COLLECTION.find({type:\"tax_blob\"}, function(err,doc){\n        console.log(doc)\n        if(q<doc.length){\n        total_amount = doc[q].total_amount\n        currency = doc[q].currency;\n\n        \n        // get the taxRate\n        COLLECTION.find({type: \"wallet\", currency: currency}, function(err,doc){\n            console.log(doc)\n        taxRate=doc.taxRate;\n        get_dividend_pathway()\n        })\n        }\n    });\n    }\n    \n    function get_dividend_pathway(){\n  \n    console.log(\"scanning collection: \"+ COLLECTION);\n    COLLECTION.find({type: \"dividend_pathway\", currency: currency},function(err, doc) {\n    console.log(doc)\n    callback(doc)\n\n    });\n\n}\n\n}\n\n        \n\n\nvar get_collection = function() {\n    //connect your coin here, this is how you connect to the API\n    //the callback feeds collection/dividend-pathways\n    //this example connects with http://client.basicincome.co\nget_dividend_lines(swarm_redistribution)\n}\n\nget_collection()        \n\n\n// -------------------------- STUFF:\n// ALL THIS needs to be improved...\n\n    var lines = [];//lines.push(line)\n   \n    \n    var x = 0;//recursion()\n    var y = 0;//recursion()\n   \n    var temp = \" \";\n    \n    var taxRate_quota_temp = []\n    var taxRate_quota_sum = 0\n    var taxRate_switch = false\n    var taxRate_x;\n    var taxRate_ratio_x;\n\n\n\n\n\n// ---------------------- SWARM-REDISTRIBUTION ----------------------------\n\nfunction swarm_redistribution(pathway){\n\nconsole.log(pathway)\n\n// ------- First, construct fractal dividend lines -----------------\n// see http://www.resilience.me/theory.html\n\n\n var w = 0;\n var line = []\n\n if(pathway.length>0){\n\n    loop(pathway, line, w);// add taxRate ratios\n    \n }\n else{\n console.log(\"collection is empty\")\n next_node()\n }\n\n    \n    \n    \n    function loop(pathway, line, w) {\n    var q = 0\n    // calculate taxRatio\n    console.log(w)\n    console.log(pathway[w])\n    var taxRate_y = pathway[w].taxRate\n    if(taxRate_switch === false){\n     taxRate_x = taxRate\n     taxRate_ratio_x = 1\n    }\n    else taxRate_x = taxRate\n    if(taxRate_y > taxRate_x)taxRate_y = taxRate_x\n    var taxRate_ratio_y = Number(taxRate_y) / Number(taxRate_x)\n    var taxRate_quota = Number(taxRate_ratio_x) * Number(taxRate_ratio_y)\n    console.log(temp.indexOf(pathway[w].account))\n    \n    // push lines\n    if (temp.indexOf(pathway[w].account) === -1){\n    temp+= pathway[w].account + \" \"\n    line.push({account: pathway[w].account, currency: currency, taxRate: taxRate, taxRate_quota: taxRate_quota});\n    taxRate_quota_temp.push(taxRate_quota)\n    taxRate_quota_sum = Number(taxRate_quota_sum) + Number(taxRate_quota)\n    q++\n    }\n    else console.log(\"CIRCULAR\");\n    \n    w++;\n    \n    if (w<pathway.length){loop(pathway, w, line)}\n    else {\n        if (q>0){\n            console.log(line);//lists all dividend pathways in IOUs[0] for ACCOUNT_ID\n            lines.push(line)\n        };\n        \n        next_node()\n    }\n    }\n\n      \n// STEP 2: branch out (add all dividend pathways for lines[x][i].account)        \n\n\n    function next_node(){\n            if(x<lines.length){\n            console.log(\"recursion nr \"+x)\n        if(y<lines[x].length){\n            console.log(\"taxRate_quota:\" +lines[x][y].taxRate_quota)\n            taxRate_ratio_x = Number(lines[x][y].taxRate_quota)\n            taxRate_x = lines[x][y].taxRate\n            COLLECTION = lines[x][y].account;\n            y++;\n            get_collection();\n        }\n                \n        else {\n           x++;\n           y = 0;\n            console.log(\"recursion nr \"+x)\n            get_collection()\n        }\n        \n            }\n            else console.log(lines), console.log(\"END\"), outgoing_payments()\n        }\n         \n             \n    // ------- SECOND, outgoing payments -----------------\n    // see http://www.resilience.me/theory.html \n    function outgoing_payments(){\n         var total_amount_pie = Number(total_amount)/taxRate_quota_sum\n         \n         // create outgoing payment\n         x = 0\n         y = 0\n         loop()\n         function loop(){\n            if (x<lines.length){     \n                if (y<lines[x].length){\n                \n                var amount = Number(total_amount_pie * lines[x][y].taxRate_quota)\n                var currency = lines[x][y].currency\n                var account = lines[x][y].account\n                var payment = {account: account, amount: amount, currency: currency}\n                \n            callback(payment)\n                y++\n                loop()\n                }\n                else x++\n                loop()\n            }else q++, get_collection();\n         }\n}\n   \n\n        \n}//end swarm_redistribution()\n\n\n\n};","undoManager":{"mark":-2,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":0,"column":35},"end":{"row":1,"column":0},"action":"insert","lines":["",""]},{"start":{"row":1,"column":0},"end":{"row":1,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":23},"end":{"row":0,"column":24},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":24},"end":{"row":0,"column":25},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":25},"end":{"row":0,"column":26},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":26},"end":{"row":0,"column":27},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":2,"column":2},"end":{"row":3,"column":89},"action":"remove","lines":["var mongojs = require(\"mongojs\")","    var db = mongojs(\"mongodb://AwSZome:jn0903@ds059907.mongolab.com:59907/awesome_box\");"]}]}],[{"group":"doc","deltas":[{"start":{"row":2,"column":1},"end":{"row":2,"column":2},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":2,"column":0},"end":{"row":2,"column":1},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":29,"column":0},"end":{"row":30,"column":0},"action":"remove","lines":["console.log(COLLECTION)",""]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":0},"end":{"row":69,"column":0},"action":"remove","lines":["get_dividend_lines()",""]},{"start":{"row":68,"column":0},"end":{"row":68,"column":1},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":1},"end":{"row":68,"column":2},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":2},"end":{"row":68,"column":3},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":3},"end":{"row":68,"column":4},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":4},"end":{"row":68,"column":5},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":5},"end":{"row":68,"column":6},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":6},"end":{"row":68,"column":7},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":7},"end":{"row":68,"column":8},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":8},"end":{"row":68,"column":9},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":9},"end":{"row":68,"column":10},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":10},"end":{"row":68,"column":11},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":11},"end":{"row":68,"column":12},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":12},"end":{"row":68,"column":13},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":13},"end":{"row":68,"column":14},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":14},"end":{"row":68,"column":16},"action":"insert","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":68,"column":15},"end":{"row":68,"column":15},"action":"insert","lines":[""]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":0},"end":{"row":62,"column":0},"action":"insert","lines":["    callback(doc)",""]}]}],[{"group":"doc","deltas":[{"start":{"row":61,"column":17},"end":{"row":62,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":67,"column":1},"end":{"row":68,"column":0},"action":"insert","lines":["",""]},{"start":{"row":68,"column":0},"end":{"row":68,"column":0},"action":"insert","lines":[""]}]}],[{"group":"doc","deltas":[{"start":{"row":69,"column":0},"end":{"row":70,"column":0},"action":"remove","lines":["get_collection()        ",""]}]}],[{"group":"doc","deltas":[{"start":{"row":79,"column":0},"end":{"row":80,"column":0},"action":"insert","lines":["get_collection()        ",""]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":0},"end":{"row":224,"column":0},"action":"insert","lines":["var server = ws.createServer(function (conn) {",""]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":0},"end":{"row":224,"column":0},"action":"remove","lines":["var server = ws.createServer(function (conn) {",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":38},"end":{"row":0,"column":39},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":38},"end":{"row":0,"column":39},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"remove","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":38},"end":{"row":0,"column":39},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":39},"end":{"row":0,"column":40},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":40},"end":{"row":0,"column":41},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":41},"end":{"row":0,"column":42},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":42},"end":{"row":0,"column":43},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":43},"end":{"row":0,"column":44},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":44},"end":{"row":0,"column":45},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":45},"end":{"row":0,"column":46},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":46},"end":{"row":0,"column":47},"action":"insert","lines":["k"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":0},"end":{"row":223,"column":1},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":1},"end":{"row":223,"column":2},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":2},"end":{"row":223,"column":3},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":3},"end":{"row":223,"column":4},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":4},"end":{"row":223,"column":5},"action":"insert","lines":["b"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":5},"end":{"row":223,"column":6},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":6},"end":{"row":223,"column":7},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":7},"end":{"row":223,"column":8},"action":"insert","lines":["k"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":8},"end":{"row":223,"column":10},"action":"insert","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":9},"end":{"row":223,"column":10},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":10},"end":{"row":223,"column":11},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":11},"end":{"row":223,"column":12},"action":"insert","lines":["y"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":12},"end":{"row":223,"column":13},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":13},"end":{"row":223,"column":14},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":14},"end":{"row":223,"column":15},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":15},"end":{"row":223,"column":16},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":17},"end":{"row":228,"column":1},"action":"remove","lines":["","function send_client(payment){","    console.log(\"outgoing payments sent !\")","            conn.sendText(JSON.stringify(payment));","            ","}"]}]}],[{"group":"doc","deltas":[{"start":{"row":223,"column":0},"end":{"row":224,"column":0},"action":"remove","lines":["callback(payment)",""]}]}],[{"group":"doc","deltas":[{"start":{"row":213,"column":0},"end":{"row":214,"column":0},"action":"remove","lines":["                send_client(payment)",""]},{"start":{"row":213,"column":0},"end":{"row":214,"column":0},"action":"insert","lines":["callback(payment)",""]}]}],[{"group":"doc","deltas":[{"start":{"row":213,"column":0},"end":{"row":213,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":213,"column":4},"end":{"row":213,"column":8},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":213,"column":8},"end":{"row":213,"column":12},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":0},"end":{"row":28,"column":1},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":1},"end":{"row":28,"column":2},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":2},"end":{"row":28,"column":3},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":3},"end":{"row":28,"column":4},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":4},"end":{"row":28,"column":5},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":5},"end":{"row":28,"column":6},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":6},"end":{"row":28,"column":7},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":7},"end":{"row":28,"column":8},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":7},"end":{"row":28,"column":8},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":7},"end":{"row":28,"column":8},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":8},"end":{"row":28,"column":9},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":9},"end":{"row":28,"column":10},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":10},"end":{"row":28,"column":12},"action":"insert","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":10},"end":{"row":28,"column":12},"action":"remove","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":9},"end":{"row":28,"column":10},"action":"remove","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":8},"end":{"row":28,"column":9},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":7},"end":{"row":28,"column":8},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":7},"end":{"row":28,"column":8},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":8},"end":{"row":28,"column":9},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":9},"end":{"row":28,"column":10},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":10},"end":{"row":28,"column":11},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":11},"end":{"row":28,"column":13},"action":"insert","lines":["()"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":12},"end":{"row":28,"column":13},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":13},"end":{"row":28,"column":14},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":14},"end":{"row":28,"column":15},"action":"insert","lines":["L"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":15},"end":{"row":28,"column":16},"action":"insert","lines":["L"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":16},"end":{"row":28,"column":17},"action":"insert","lines":["E"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":17},"end":{"row":28,"column":18},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":18},"end":{"row":28,"column":19},"action":"insert","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":19},"end":{"row":28,"column":20},"action":"insert","lines":["I"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":20},"end":{"row":28,"column":21},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":28,"column":21},"end":{"row":28,"column":22},"action":"insert","lines":["N"]}]}],[{"group":"doc","deltas":[{"start":{"row":212,"column":84},"end":{"row":213,"column":0},"action":"insert","lines":["",""]},{"start":{"row":213,"column":0},"end":{"row":213,"column":16},"action":"insert","lines":["                "]}]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":28,"column":0},"end":{"row":29,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":10,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1417023596213}