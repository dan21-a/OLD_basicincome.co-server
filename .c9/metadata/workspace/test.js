{"filter":false,"title":"test.js","tooltip":"/test.js","undoManager":{"mark":100,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":215,"column":147},"end":{"row":215,"column":148},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":147},"end":{"row":215,"column":148},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":146},"end":{"row":215,"column":147},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":145},"end":{"row":215,"column":146},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":145},"end":{"row":215,"column":146},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":146},"end":{"row":215,"column":147},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":147},"end":{"row":215,"column":148},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":148},"end":{"row":215,"column":149},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":149},"end":{"row":215,"column":150},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":150},"end":{"row":215,"column":151},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":151},"end":{"row":215,"column":152},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":215,"column":152},"end":{"row":215,"column":153},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":71,"column":61},"end":{"row":72,"column":0},"action":"insert","lines":["",""]},{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":4},"end":{"row":72,"column":43},"action":"insert","lines":["COLLECTION = db.collection(account_id);"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":0},"end":{"row":72,"column":4},"action":"remove","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":27},"end":{"row":72,"column":37},"action":"remove","lines":["account_id"]},{"start":{"row":72,"column":27},"end":{"row":72,"column":28},"action":"insert","lines":["A"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":28},"end":{"row":72,"column":29},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":29},"end":{"row":72,"column":30},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":30},"end":{"row":72,"column":31},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":30},"end":{"row":72,"column":31},"action":"remove","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":29},"end":{"row":72,"column":30},"action":"remove","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":29},"end":{"row":72,"column":30},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":30},"end":{"row":72,"column":31},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":31},"end":{"row":72,"column":32},"action":"insert","lines":["U"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":32},"end":{"row":72,"column":33},"action":"insert","lines":["N"]}]}],[{"group":"doc","deltas":[{"start":{"row":72,"column":33},"end":{"row":72,"column":34},"action":"insert","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":11},"end":{"row":25,"column":12},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":12},"end":{"row":25,"column":13},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":13},"end":{"row":25,"column":14},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":14},"end":{"row":25,"column":15},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":15},"end":{"row":25,"column":16},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":16},"end":{"row":25,"column":17},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":17},"end":{"row":25,"column":18},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":18},"end":{"row":25,"column":19},"action":"insert","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":18},"end":{"row":25,"column":19},"action":"remove","lines":["8"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":18},"end":{"row":25,"column":19},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":19},"end":{"row":25,"column":20},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":20},"end":{"row":25,"column":21},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":21},"end":{"row":25,"column":22},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":21},"end":{"row":25,"column":22},"action":"remove","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":21},"end":{"row":25,"column":22},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":22},"end":{"row":25,"column":23},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":25,"column":23},"end":{"row":25,"column":24},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":31},"end":{"row":27,"column":41},"action":"remove","lines":["account_id"]},{"start":{"row":27,"column":31},"end":{"row":27,"column":32},"action":"insert","lines":["A"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":32},"end":{"row":27,"column":33},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":33},"end":{"row":27,"column":34},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":34},"end":{"row":27,"column":35},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":35},"end":{"row":27,"column":36},"action":"insert","lines":["U"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":36},"end":{"row":27,"column":37},"action":"insert","lines":["N"]}]}],[{"group":"doc","deltas":[{"start":{"row":27,"column":37},"end":{"row":27,"column":38},"action":"insert","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":129},"end":{"row":142,"column":139},"action":"remove","lines":["COLLECTION"]},{"start":{"row":142,"column":129},"end":{"row":142,"column":130},"action":"insert","lines":["A"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":130},"end":{"row":142,"column":131},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":131},"end":{"row":142,"column":132},"action":"insert","lines":["C"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":132},"end":{"row":142,"column":133},"action":"insert","lines":["O"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":133},"end":{"row":142,"column":134},"action":"insert","lines":["U"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":134},"end":{"row":142,"column":135},"action":"insert","lines":["N"]}]}],[{"group":"doc","deltas":[{"start":{"row":142,"column":135},"end":{"row":142,"column":136},"action":"insert","lines":["T"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":83},"end":{"row":209,"column":84},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":84},"end":{"row":209,"column":85},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":85},"end":{"row":209,"column":86},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":86},"end":{"row":209,"column":87},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":87},"end":{"row":209,"column":88},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":88},"end":{"row":209,"column":89},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":89},"end":{"row":209,"column":90},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":90},"end":{"row":209,"column":91},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":91},"end":{"row":209,"column":92},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":91},"end":{"row":209,"column":92},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":90},"end":{"row":209,"column":91},"action":"remove","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":89},"end":{"row":209,"column":90},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":89},"end":{"row":209,"column":90},"action":"insert","lines":[":"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":90},"end":{"row":209,"column":91},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":91},"end":{"row":209,"column":102},"action":"insert","lines":["lines[x][y]"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":102},"end":{"row":209,"column":103},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":103},"end":{"row":209,"column":104},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":104},"end":{"row":209,"column":105},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":105},"end":{"row":209,"column":106},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":209,"column":106},"end":{"row":209,"column":107},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":0},"end":{"row":222,"column":29},"action":"remove","lines":["var ACCOUNT_ID = db.collection(account_id);","var ACCOUNT = account_id","","var COLLECTION = db.collection(ACCOUNT);","    ","    ","var q = 0//loop through all currencies","","function get_dividend_lines(callback){","    get_wallet()","    function get_wallet(){","    ACCOUNT_ID.find({type:\"tax_blob\"}, function(err,doc){","        ","        if(q<doc.length){","        var total_amount = doc[q].total_amount","        var currency = doc[q].currency","","        // get the taxRate","        ACCOUNT_ID.findOne({type: \"wallet\", currency: doc[q].currency}, function(err,doc){","","        var taxRate=doc.taxRate;","","        get_dividend_pathway(taxRate, currency, total_amount)","        })","        }","        else console.log(\"swarm-redistribution finished for all currencies\")","    });","    }","    ","    function get_dividend_pathway(taxRate, currency, total_amount){","  ","    console.log(\"scanning collection: \"+ COLLECTION);","    COLLECTION.find({type: \"dividend_pathway\", currency: currency},function(err, doc) {","","    callback(doc, taxRate, total_amount)","","    });","","}","","}","","        ","","var get_collection = function() {","    //connect your coin here, this is how you connect to the API","    //the callback feeds collection/dividend-pathways","    //this example connects with http://client.basicincome.co","COLLECTION = db.collection(ACCOUNT);","get_dividend_lines(swarm_redistribution)","}","get_collection()","","","// -------------------------- STUFF:","// ALL THIS needs to be improved...","","    var lines = [];//lines.push(line)","   ","    ","    var x = 0;//recursion()","    var y = 0;//recursion()","    var z = 0","   ","    var taxRate_quota_sum = 0","    var taxRate_switch = false","    var taxRate_x;","    var taxRate_ratio_x;","","","","","","// ---------------------- SWARM-REDISTRIBUTION ----------------------------","","function swarm_redistribution(pathway, taxRate, total_amount){","","","// ------- First, construct fractal dividend lines -----------------","// see http://www.resilience.me/theory.html","",""," var w = 0;"," var line = []"," "," taxRate_x = taxRate"," taxRate_ratio_x = 1","","",""," if(pathway.length>0){","","    loop(pathway, line, w, taxRate, total_amount);// add taxRate ratios","    "," }"," else{"," console.log(\"collection is empty\")"," next_node(total_amount)"," }","","    ","    ","    function loop(pathway, line, w, taxRate, total_amount) {","    // calculate taxRatio","    function calculate_taxRatio(pathway, line, w, taxRate, total_amount){","    var taxRate_y = pathway[w].taxRate","   ","    if(taxRate_y > taxRate_x)taxRate_y = taxRate_x","    var taxRate_ratio_y = Number(taxRate_y) / Number(taxRate_x)","    var taxRate_quota = Number(taxRate_ratio_x) * Number(taxRate_ratio_y)","    push_lines(taxRate_quota, total_amount)","    }","    calculate_taxRatio(pathway, line, w, taxRate, total_amount)","","    function push_lines(taxRate_quota, total_amount){","","    // push lines","    if (JSON.stringify(lines).indexOf(pathway[w].account) === -1 && pathway[w].account !== account_id){","    line.push({account: pathway[w].account, currency: pathway[w].currency, taxRate: taxRate, taxRate_quota: taxRate_quota, node: ACCOUNT});","    taxRate_quota_sum = Number(taxRate_quota_sum) + Number(taxRate_quota)","    }","    else console.log(\"CIRCULAR\");","    ","    w++;","    console.log(w)","    ","    if (w<pathway.length){loop(pathway, line, w, taxRate, total_amount)}","    else {","        if (line.length>0){","            lines.push(line)","        };","        console.log(lines)","        next_node(total_amount)","    }","    }","    }","","      ","// STEP 2: branch out (add all dividend pathways for lines[x][i].account)        ","","","    function next_node(total_amount){","            if(x<lines.length){","            ","                ","        if(y<lines[x].length){","            taxRate_ratio_x = Number(lines[x][y].taxRate_quota)","            taxRate_x = lines[x][y].taxRate","            ACCOUNT = lines[x][y].account;","            ","            y++;","            z++","            console.log(\"recursion nr \"+z)","            get_collection();","        }","                ","        else {","            x++;","            y = 0","            next_node(total_amount)","          ","        }","        ","            }","            else console.log(lines), console.log(\"generating payments...\"), outgoing_payments(total_amount)","        }","         ","             ","    // ------- SECOND, outgoing payments -----------------","    // see http://www.resilience.me/theory.html ","    function outgoing_payments(total_amount){","         var total_amount_pie = Number(total_amount)/taxRate_quota_sum","         ","         // create outgoing payment","         x = 0","         y = 0","         loop()","         function loop(){","","            if (x<lines.length){     ","                if (y<lines[x].length){","                console.log(lines[x][y])","                var amount = Number(total_amount_pie * lines[x][y].taxRate_quota)","                var currency = lines[x][y].currency","                var account = lines[x][y].account","                var payment = {account: account, amount: amount, currency: currency, node: lines[x][y].node}","                ","                console.log(payment)","                y++","                loop()","                }","                else x++, y =0, loop()","            }else q++, console.log(\"swarm-redistribution for currency: \"+lines[0][0].currency +\" is done. loading next currency...\"),ACCOUNT = account_id, get_collection();","         }//create outgoing payments to everyone in the swarm","    }","   ","","        ","}//end swarm_redistribution()"]},{"start":{"row":24,"column":0},"end":{"row":222,"column":29},"action":"insert","lines":["var ACCOUNT_ID = db.collection(account_id);","var ACCOUNT = account_id","","var COLLECTION = db.collection(ACCOUNT);","    ","    ","var q = 0//loop through all currencies","","function get_dividend_lines(callback){","    get_wallet()","    function get_wallet(){","    ACCOUNT_ID.find({type:\"tax_blob\"}, function(err,doc){","        ","        if(q<doc.length){","        var total_amount = doc[q].total_amount","        var currency = doc[q].currency","","        // get the taxRate","        ACCOUNT_ID.findOne({type: \"wallet\", currency: doc[q].currency}, function(err,doc){","","        var taxRate=doc.taxRate;","","        get_dividend_pathway(taxRate, currency, total_amount)","        })","        }","        else console.log(\"swarm-redistribution finished for all currencies\")","    });","    }","    ","    function get_dividend_pathway(taxRate, currency, total_amount){","  ","    console.log(\"scanning collection: \"+ COLLECTION);","    COLLECTION.find({type: \"dividend_pathway\", currency: currency},function(err, doc) {","","    callback(doc, taxRate, total_amount)","","    });","","}","","}","","        ","","var get_collection = function() {","    //connect your coin here, this is how you connect to the API","    //the callback feeds collection/dividend-pathways","    //this example connects with http://client.basicincome.co","COLLECTION = db.collection(ACCOUNT);","get_dividend_lines(swarm_redistribution)","}","get_collection()","","","// -------------------------- STUFF:","// ALL THIS needs to be improved...","","    var lines = [];//lines.push(line)","   ","    ","    var x = 0;//recursion()","    var y = 0;//recursion()","    var z = 0","   ","    var taxRate_quota_sum = 0","    var taxRate_switch = false","    var taxRate_x;","    var taxRate_ratio_x;","","","","","","// ---------------------- SWARM-REDISTRIBUTION ----------------------------","","function swarm_redistribution(pathway, taxRate, total_amount){","","","// ------- First, construct fractal dividend lines -----------------","// see http://www.resilience.me/theory.html","",""," var w = 0;"," var line = []"," "," taxRate_x = taxRate"," taxRate_ratio_x = 1","","",""," if(pathway.length>0){","","    loop(pathway, line, w, taxRate, total_amount);// add taxRate ratios","    "," }"," else{"," console.log(\"collection is empty\")"," next_node(total_amount)"," }","","    ","    ","    function loop(pathway, line, w, taxRate, total_amount) {","    // calculate taxRatio","    function calculate_taxRatio(pathway, line, w, taxRate, total_amount){","    var taxRate_y = pathway[w].taxRate","   ","    if(taxRate_y > taxRate_x)taxRate_y = taxRate_x","    var taxRate_ratio_y = Number(taxRate_y) / Number(taxRate_x)","    var taxRate_quota = Number(taxRate_ratio_x) * Number(taxRate_ratio_y)","    push_lines(taxRate_quota, total_amount)","    }","    calculate_taxRatio(pathway, line, w, taxRate, total_amount)","","    function push_lines(taxRate_quota, total_amount){","","    // push lines","    if (JSON.stringify(lines).indexOf(pathway[w].account) === -1 && pathway[w].account !== account_id){","    line.push({account: pathway[w].account, currency: pathway[w].currency, taxRate: taxRate, taxRate_quota: taxRate_quota, node: ACCOUNT});","    taxRate_quota_sum = Number(taxRate_quota_sum) + Number(taxRate_quota)","    }","    else console.log(\"CIRCULAR\");","    ","    w++;","    console.log(w)","    ","    if (w<pathway.length){loop(pathway, line, w, taxRate, total_amount)}","    else {","        if (line.length>0){","            lines.push(line)","        };","        console.log(lines)","        next_node(total_amount)","    }","    }","    }","","      ","// STEP 2: branch out (add all dividend pathways for lines[x][i].account)        ","","","    function next_node(total_amount){","            if(x<lines.length){","            ","                ","        if(y<lines[x].length){","            taxRate_ratio_x = Number(lines[x][y].taxRate_quota)","            taxRate_x = lines[x][y].taxRate","            ACCOUNT = lines[x][y].account;","            ","            y++;","            z++","            console.log(\"recursion nr \"+z)","            get_collection();","        }","                ","        else {","            x++;","            y = 0","            next_node(total_amount)","          ","        }","        ","            }","            else console.log(lines), console.log(\"generating payments...\"), outgoing_payments(total_amount)","        }","         ","             ","    // ------- SECOND, outgoing payments -----------------","    // see http://www.resilience.me/theory.html ","    function outgoing_payments(total_amount){","         var total_amount_pie = Number(total_amount)/taxRate_quota_sum","         ","         // create outgoing payment","         x = 0","         y = 0","         loop()","         function loop(){","","            if (x<lines.length){     ","                if (y<lines[x].length){","                console.log(lines[x][y])","                var amount = Number(total_amount_pie * lines[x][y].taxRate_quota)","                var currency = lines[x][y].currency","                var account = lines[x][y].account","                var payment = {account: account, amount: amount, currency: currency, node: lines[x][y].node}","                ","                callback(payment, account_id)","                y++","                loop()","                }","                else x++, y =0, loop()","            }else q++, console.log(\"swarm-redistribution for currency: \"+lines[0][0].currency +\" is done. loading next currency...\"),ACCOUNT = account_id, get_collection();","         }//create outgoing payments to everyone in the swarm","    }","   ","","        ","}//end swarm_redistribution()"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":16},"end":{"row":211,"column":24},"action":"remove","lines":["callback"]},{"start":{"row":211,"column":16},"end":{"row":211,"column":17},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":17},"end":{"row":211,"column":18},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":18},"end":{"row":211,"column":19},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":19},"end":{"row":211,"column":20},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":20},"end":{"row":211,"column":21},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":21},"end":{"row":211,"column":22},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":22},"end":{"row":211,"column":23},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":23},"end":{"row":211,"column":24},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":24},"end":{"row":211,"column":25},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":25},"end":{"row":211,"column":26},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":26},"end":{"row":211,"column":27},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":24,"column":0},"end":{"row":222,"column":29},"action":"remove","lines":["var ACCOUNT_ID = db.collection(account_id);","var ACCOUNT = account_id","","var COLLECTION = db.collection(ACCOUNT);","    ","    ","var q = 0//loop through all currencies","","function get_dividend_lines(callback){","    get_wallet()","    function get_wallet(){","    ACCOUNT_ID.find({type:\"tax_blob\"}, function(err,doc){","        ","        if(q<doc.length){","        var total_amount = doc[q].total_amount","        var currency = doc[q].currency","","        // get the taxRate","        ACCOUNT_ID.findOne({type: \"wallet\", currency: doc[q].currency}, function(err,doc){","","        var taxRate=doc.taxRate;","","        get_dividend_pathway(taxRate, currency, total_amount)","        })","        }","        else console.log(\"swarm-redistribution finished for all currencies\")","    });","    }","    ","    function get_dividend_pathway(taxRate, currency, total_amount){","  ","    console.log(\"scanning collection: \"+ COLLECTION);","    COLLECTION.find({type: \"dividend_pathway\", currency: currency},function(err, doc) {","","    callback(doc, taxRate, total_amount)","","    });","","}","","}","","        ","","var get_collection = function() {","    //connect your coin here, this is how you connect to the API","    //the callback feeds collection/dividend-pathways","    //this example connects with http://client.basicincome.co","COLLECTION = db.collection(ACCOUNT);","get_dividend_lines(swarm_redistribution)","}","get_collection()","","","// -------------------------- STUFF:","// ALL THIS needs to be improved...","","    var lines = [];//lines.push(line)","   ","    ","    var x = 0;//recursion()","    var y = 0;//recursion()","    var z = 0","   ","    var taxRate_quota_sum = 0","    var taxRate_switch = false","    var taxRate_x;","    var taxRate_ratio_x;","","","","","","// ---------------------- SWARM-REDISTRIBUTION ----------------------------","","function swarm_redistribution(pathway, taxRate, total_amount){","","","// ------- First, construct fractal dividend lines -----------------","// see http://www.resilience.me/theory.html","",""," var w = 0;"," var line = []"," "," taxRate_x = taxRate"," taxRate_ratio_x = 1","","",""," if(pathway.length>0){","","    loop(pathway, line, w, taxRate, total_amount);// add taxRate ratios","    "," }"," else{"," console.log(\"collection is empty\")"," next_node(total_amount)"," }","","    ","    ","    function loop(pathway, line, w, taxRate, total_amount) {","    // calculate taxRatio","    function calculate_taxRatio(pathway, line, w, taxRate, total_amount){","    var taxRate_y = pathway[w].taxRate","   ","    if(taxRate_y > taxRate_x)taxRate_y = taxRate_x","    var taxRate_ratio_y = Number(taxRate_y) / Number(taxRate_x)","    var taxRate_quota = Number(taxRate_ratio_x) * Number(taxRate_ratio_y)","    push_lines(taxRate_quota, total_amount)","    }","    calculate_taxRatio(pathway, line, w, taxRate, total_amount)","","    function push_lines(taxRate_quota, total_amount){","","    // push lines","    if (JSON.stringify(lines).indexOf(pathway[w].account) === -1 && pathway[w].account !== account_id){","    line.push({account: pathway[w].account, currency: pathway[w].currency, taxRate: taxRate, taxRate_quota: taxRate_quota, node: ACCOUNT});","    taxRate_quota_sum = Number(taxRate_quota_sum) + Number(taxRate_quota)","    }","    else console.log(\"CIRCULAR\");","    ","    w++;","    console.log(w)","    ","    if (w<pathway.length){loop(pathway, line, w, taxRate, total_amount)}","    else {","        if (line.length>0){","            lines.push(line)","        };","        console.log(lines)","        next_node(total_amount)","    }","    }","    }","","      ","// STEP 2: branch out (add all dividend pathways for lines[x][i].account)        ","","","    function next_node(total_amount){","            if(x<lines.length){","            ","                ","        if(y<lines[x].length){","            taxRate_ratio_x = Number(lines[x][y].taxRate_quota)","            taxRate_x = lines[x][y].taxRate","            ACCOUNT = lines[x][y].account;","            ","            y++;","            z++","            console.log(\"recursion nr \"+z)","            get_collection();","        }","                ","        else {","            x++;","            y = 0","            next_node(total_amount)","          ","        }","        ","            }","            else console.log(lines), console.log(\"generating payments...\"), outgoing_payments(total_amount)","        }","         ","             ","    // ------- SECOND, outgoing payments -----------------","    // see http://www.resilience.me/theory.html ","    function outgoing_payments(total_amount){","         var total_amount_pie = Number(total_amount)/taxRate_quota_sum","         ","         // create outgoing payment","         x = 0","         y = 0","         loop()","         function loop(){","","            if (x<lines.length){     ","                if (y<lines[x].length){","                console.log(lines[x][y])","                var amount = Number(total_amount_pie * lines[x][y].taxRate_quota)","                var currency = lines[x][y].currency","                var account = lines[x][y].account","                var payment = {account: account, amount: amount, currency: currency, node: lines[x][y].node}","                ","                console.log(payment, account_id)","                y++","                loop()","                }","                else x++, y =0, loop()","            }else q++, console.log(\"swarm-redistribution for currency: \"+lines[0][0].currency +\" is done. loading next currency...\"),ACCOUNT = account_id, get_collection();","         }//create outgoing payments to everyone in the swarm","    }","   ","","        ","}//end swarm_redistribution()"]},{"start":{"row":24,"column":0},"end":{"row":222,"column":29},"action":"insert","lines":["var ACCOUNT_ID = db.collection(account_id);","var ACCOUNT = account_id","","var COLLECTION = db.collection(ACCOUNT);","    ","    ","var q = 0//loop through all currencies","","function get_dividend_lines(callback){","    get_wallet()","    function get_wallet(){","    ACCOUNT_ID.find({type:\"tax_blob\"}, function(err,doc){","        ","        if(q<doc.length){","        var total_amount = doc[q].total_amount","        var currency = doc[q].currency","","        // get the taxRate","        ACCOUNT_ID.findOne({type: \"wallet\", currency: doc[q].currency}, function(err,doc){","","        var taxRate=doc.taxRate;","","        get_dividend_pathway(taxRate, currency, total_amount)","        })","        }","        else console.log(\"swarm-redistribution finished for all currencies\")","    });","    }","    ","    function get_dividend_pathway(taxRate, currency, total_amount){","  ","    console.log(\"scanning collection: \"+ COLLECTION);","    COLLECTION.find({type: \"dividend_pathway\", currency: currency},function(err, doc) {","","    callback(doc, taxRate, total_amount)","","    });","","}","","}","","        ","","var get_collection = function() {","    //connect your coin here, this is how you connect to the API","    //the callback feeds collection/dividend-pathways","    //this example connects with http://client.basicincome.co","COLLECTION = db.collection(ACCOUNT);","get_dividend_lines(swarm_redistribution)","}","get_collection()","","","// -------------------------- STUFF:","// ALL THIS needs to be improved...","","    var lines = [];//lines.push(line)","   ","    ","    var x = 0;//recursion()","    var y = 0;//recursion()","    var z = 0","   ","    var taxRate_quota_sum = 0","    var taxRate_switch = false","    var taxRate_x;","    var taxRate_ratio_x;","","","","","","// ---------------------- SWARM-REDISTRIBUTION ----------------------------","","function swarm_redistribution(pathway, taxRate, total_amount){","","","// ------- First, construct fractal dividend lines -----------------","// see http://www.resilience.me/theory.html","",""," var w = 0;"," var line = []"," "," taxRate_x = taxRate"," taxRate_ratio_x = 1","","",""," if(pathway.length>0){","","    loop(pathway, line, w, taxRate, total_amount);// add taxRate ratios","    "," }"," else{"," console.log(\"collection is empty\")"," next_node(total_amount)"," }","","    ","    ","    function loop(pathway, line, w, taxRate, total_amount) {","    // calculate taxRatio","    function calculate_taxRatio(pathway, line, w, taxRate, total_amount){","    var taxRate_y = pathway[w].taxRate","   ","    if(taxRate_y > taxRate_x)taxRate_y = taxRate_x","    var taxRate_ratio_y = Number(taxRate_y) / Number(taxRate_x)","    var taxRate_quota = Number(taxRate_ratio_x) * Number(taxRate_ratio_y)","    push_lines(taxRate_quota, total_amount)","    }","    calculate_taxRatio(pathway, line, w, taxRate, total_amount)","","    function push_lines(taxRate_quota, total_amount){","","    // push lines","    if (JSON.stringify(lines).indexOf(pathway[w].account) === -1 && pathway[w].account !== account_id){","    line.push({account: pathway[w].account, currency: pathway[w].currency, taxRate: taxRate, taxRate_quota: taxRate_quota, node: ACCOUNT});","    taxRate_quota_sum = Number(taxRate_quota_sum) + Number(taxRate_quota)","    }","    else console.log(\"CIRCULAR\");","    ","    w++;","    console.log(w)","    ","    if (w<pathway.length){loop(pathway, line, w, taxRate, total_amount)}","    else {","        if (line.length>0){","            lines.push(line)","        };","        console.log(lines)","        next_node(total_amount)","    }","    }","    }","","      ","// STEP 2: branch out (add all dividend pathways for lines[x][i].account)        ","","","    function next_node(total_amount){","            if(x<lines.length){","            ","                ","        if(y<lines[x].length){","            taxRate_ratio_x = Number(lines[x][y].taxRate_quota)","            taxRate_x = lines[x][y].taxRate","            ACCOUNT = lines[x][y].account;","            ","            y++;","            z++","            console.log(\"recursion nr \"+z)","            get_collection();","        }","                ","        else {","            x++;","            y = 0","            next_node(total_amount)","          ","        }","        ","            }","            else console.log(lines), console.log(\"generating payments...\"), outgoing_payments(total_amount)","        }","         ","             ","    // ------- SECOND, outgoing payments -----------------","    // see http://www.resilience.me/theory.html ","    function outgoing_payments(total_amount){","         var total_amount_pie = Number(total_amount)/taxRate_quota_sum","         ","         // create outgoing payment","         x = 0","         y = 0","         loop()","         function loop(){","","            if (x<lines.length){     ","                if (y<lines[x].length){","                console.log(lines[x][y])","                var amount = Number(total_amount_pie * lines[x][y].taxRate_quota)","                var currency = lines[x][y].currency","                var account = lines[x][y].account","                var payment = {account: account, amount: amount, currency: currency, node: lines[x][y].node}","                ","                callback(payment, account_id)","                y++","                loop()","                }","                else x++, y =0, loop()","            }else q++, console.log(\"swarm-redistribution for currency: \"+lines[0][0].currency +\" is done. loading next currency...\"),ACCOUNT = account_id, get_collection();","         }//create outgoing payments to everyone in the swarm","    }","   ","","        ","}//end swarm_redistribution()"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":16},"end":{"row":211,"column":24},"action":"remove","lines":["callback"]},{"start":{"row":211,"column":16},"end":{"row":211,"column":17},"action":"insert","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":17},"end":{"row":211,"column":18},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":18},"end":{"row":211,"column":19},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":19},"end":{"row":211,"column":20},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":20},"end":{"row":211,"column":21},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":21},"end":{"row":211,"column":22},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":22},"end":{"row":211,"column":23},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":23},"end":{"row":211,"column":24},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":24},"end":{"row":211,"column":25},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":25},"end":{"row":211,"column":26},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":211,"column":26},"end":{"row":211,"column":27},"action":"insert","lines":["g"]}]}]]},"ace":{"folds":[],"scrolltop":2788.1111583709717,"scrollleft":0,"selection":{"start":{"row":211,"column":27},"end":{"row":211,"column":27},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":192,"state":"no_regex","mode":"ace/mode/javascript"}},"timestamp":1417148148750,"hash":"3ec73ef9ba98d01d09a880359f2e79404943c749"}