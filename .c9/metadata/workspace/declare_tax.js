{"changed":true,"filter":false,"title":"declare_tax.js","tooltip":"/declare_tax.js","value":"exports.connect = function(){\n// ---------------------------- connect to basicincome.co -----------------------------\n\nvar ws = require(\"nodejs-websocket\");\n\nvar server = ws.createServer(function (conn) {\n    console.log(\"User connected...\");\n\n\n    var BLOB\n    var ACCOUNT_ID\n    var WALLET\n    var SECRET\n    var i = 0   \n\n\n    conn.on(\"text\", function (str) {\n        \n        function do_something(){}\n        \n        console.log(\"Received: \"+str);\n        BLOB = JSON.parse(str)\n        ACCOUNT_ID = BLOB[0].account_id\n        WALLET = BLOB[1]\n        COLLECTION = ACCOUNT_ID\n\n\n\n\n\n\n// ---------------------------- swarm-redistribution ----------------------------------\n\n// FIRST, collect data from the coin platform\n\n // this example connects with http://client.basicincome.co\n\n    var taxRate\n    var total_amount\n\n    \n    var currency\n    var q = 0\n\n\nget_dividend_lines: function(callback){\n    get_wallet()\n    function get_wallet(){\n    tax_blob = mongoose.model('tax_blob', tax_blob_schema, ACCOUNT_ID);\n    // get the currency\n    tax_blob.find({type: \"tax_blob\"}).exec(function(err,doc){\n        if(q<doc.length){\n        total_amount = doc[q].total_amount\n        currency = doc[q].currency;\n\n        \n        wallet = mongoose.model('wallet', wallet_schema, ACCOUNT_ID);\n        // get the taxRate\n        wallet.findOne({type: \"wallet\", currency: currency}).exec(function(err,doc){\n        taxRate=doc.taxRate;\n        get_dividend_pathway()\n        })\n        }\n    });\n    }\n    \n    function get_dividend_pathway(){\n  \n    dividend_pathway = mongoose.model('dividend_pathway', dividend_pathways_schema, COLLECTION);//to insert new COLLECTION\n    console.log(\"scanning collection: \"+ COLLECTION);\n    dividend_pathway.find({type: \"dividend_pathway\", currency: currency} ).exec(function(err, doc) {\n    callback(doc)\n    \n\n    });\n\n}\n\n}\n\n\n\n// ---------------------------- update currency/taxRate ----------------------------------\n\n        \n\n        // update wallet\n        wallet.remove({ type: 'wallet' },function(err, wallet){})\n        loop()\n        function loop(){\n                    new wallet({ type: \"wallet\", currency: WALLET[i].currency, taxRate: WALLET[i].taxRate }).save(function(err){});\n                    i++\n                    if(i<WALLET.length){loop()}\n                    else{(i=0)\n                    if(accounts.indexOf(ACCOUNT_ID)===-1){get_collections}//add collection to request_subscribe()\n}\n        }\n        \n        \n        \n    })\n}).listen(8080); console.log(\"server listening on port 8080\");\n\n\n}","undoManager":{"mark":97,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":0,"column":30},"end":{"row":0,"column":31},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":29},"end":{"row":0,"column":30},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":28},"end":{"row":0,"column":29},"action":"remove","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":27},"end":{"row":0,"column":28},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":26},"end":{"row":0,"column":27},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":26},"end":{"row":0,"column":27},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":27},"end":{"row":0,"column":28},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":28},"end":{"row":0,"column":29},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":29},"end":{"row":0,"column":30},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":30},"end":{"row":0,"column":31},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":31},"end":{"row":0,"column":32},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":32},"end":{"row":0,"column":33},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":33},"end":{"row":0,"column":34},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":34},"end":{"row":0,"column":35},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":35},"end":{"row":0,"column":36},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":36},"end":{"row":0,"column":37},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"remove","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":36},"end":{"row":0,"column":37},"action":"remove","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":35},"end":{"row":0,"column":36},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":34},"end":{"row":0,"column":35},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":33},"end":{"row":0,"column":34},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":32},"end":{"row":0,"column":33},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":31},"end":{"row":0,"column":32},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":30},"end":{"row":0,"column":31},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":29},"end":{"row":0,"column":30},"action":"remove","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":28},"end":{"row":0,"column":29},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":27},"end":{"row":0,"column":28},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":26},"end":{"row":0,"column":27},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":26},"end":{"row":0,"column":27},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":27},"end":{"row":0,"column":28},"action":"insert","lines":["p"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":28},"end":{"row":0,"column":29},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":29},"end":{"row":0,"column":30},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":30},"end":{"row":0,"column":31},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":31},"end":{"row":0,"column":32},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":31},"end":{"row":0,"column":32},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":31},"end":{"row":0,"column":32},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":32},"end":{"row":0,"column":33},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":33},"end":{"row":0,"column":34},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":34},"end":{"row":0,"column":35},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":35},"end":{"row":0,"column":36},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":36},"end":{"row":0,"column":37},"action":"insert","lines":["x"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"insert","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"remove","lines":["_"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":37},"end":{"row":0,"column":38},"action":"insert","lines":["R"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":38},"end":{"row":0,"column":39},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":39},"end":{"row":0,"column":40},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":40},"end":{"row":0,"column":41},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":41},"end":{"row":0,"column":42},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":42},"end":{"row":0,"column":43},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":43},"end":{"row":0,"column":44},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":44},"end":{"row":0,"column":45},"action":"insert","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":45},"end":{"row":0,"column":46},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":46},"end":{"row":0,"column":47},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":47},"end":{"row":0,"column":48},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":48},"end":{"row":0,"column":49},"action":"insert","lines":[","]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":49},"end":{"row":0,"column":50},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":50},"end":{"row":0,"column":51},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":51},"end":{"row":0,"column":52},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":52},"end":{"row":0,"column":53},"action":"insert","lines":["d"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":53},"end":{"row":0,"column":54},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":54},"end":{"row":0,"column":55},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":55},"end":{"row":0,"column":56},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":56},"end":{"row":0,"column":57},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":57},"end":{"row":0,"column":58},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":58},"end":{"row":0,"column":59},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":59},"end":{"row":0,"column":60},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":59},"end":{"row":0,"column":60},"action":"remove","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":58},"end":{"row":0,"column":59},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":57},"end":{"row":0,"column":58},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":56},"end":{"row":0,"column":57},"action":"remove","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":55},"end":{"row":0,"column":56},"action":"remove","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":54},"end":{"row":0,"column":55},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":54},"end":{"row":0,"column":55},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":55},"end":{"row":0,"column":56},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":56},"end":{"row":0,"column":57},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":57},"end":{"row":0,"column":58},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":57},"end":{"row":0,"column":58},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":56},"end":{"row":0,"column":57},"action":"remove","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":55},"end":{"row":0,"column":56},"action":"remove","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":54},"end":{"row":0,"column":55},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":54},"end":{"row":0,"column":55},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":55},"end":{"row":0,"column":56},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":56},"end":{"row":0,"column":57},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":57},"end":{"row":0,"column":58},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":58},"end":{"row":0,"column":59},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":59},"end":{"row":0,"column":60},"action":"insert","lines":["m"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":60},"end":{"row":0,"column":61},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":61},"end":{"row":0,"column":62},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":62},"end":{"row":0,"column":63},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":63},"end":{"row":0,"column":64},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":64},"end":{"row":0,"column":65},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":65},"end":{"row":0,"column":66},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":66},"end":{"row":0,"column":67},"action":"insert","lines":["u"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":67},"end":{"row":0,"column":68},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":68},"end":{"row":0,"column":69},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":84,"column":0},"end":{"row":84,"column":1},"action":"remove","lines":["}"]}]}],[{"group":"doc","deltas":[{"start":{"row":46,"column":0},"end":{"row":47,"column":18},"action":"remove","lines":["","module.exports = {"]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":1,"column":41},"action":"remove","lines":["// the declare_tax module updates taxRate values, and some more stuff","// this example collects data from Ripple"]}]}],[{"group":"doc","deltas":[{"start":{"row":1,"column":0},"end":{"row":2,"column":0},"action":"remove","lines":["",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"remove","lines":["",""]}]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":0,"column":0},"end":{"row":0,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1416958303740}